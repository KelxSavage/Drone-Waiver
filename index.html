<!DOCTYPE html>
<html>
<head>
<title>Drone Racing Waiver</title>

<style>
body {
  font-family: Arial;
  max-width:600px;
  margin:auto;
  padding:20px;
}

input, textarea {
  width:100%;
  padding:10px;
  margin:10px 0;
  box-sizing:border-box;
}

button {
  background:black;
  color:white;
  padding:15px;
  width:100%;
  cursor:pointer;
}

#waiverText {
  height:220px;
  resize:none;
}
</style>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>

<body>

<h2>Drone Racing Waiver</h2>

<form id="waiverForm"
      action="https://formsubmit.co/00ce3a8518aaf4e0d1093828f1eab7f7"
      method="POST"
      enctype="multipart/form-data"
      onsubmit="return handleSubmit(event)">

<input type="text" name="Participant Name" placeholder="Participant Name" required>

<input type="number" id="age" name="Age" placeholder="Age" required>

<input type="text" id="guardian" name="Guardian Name"
       placeholder="Parent/Guardian (only if under 18)">

<input type="email" id="email" name="email" placeholder="Email" required>

<input type="text" name="Phone" placeholder="Phone Number" required>

<textarea id="waiverText" readonly>
DRONE RACING LIABILITY WAIVER & RELEASE

I understand that participation in drone racing involves small flying aircraft and carries risks including, but not limited to, minor injury, property damage, or equipment malfunction.

I voluntarily choose to participate (or allow my child to participate) in drone racing activities operated by Velocity Labs by Kel Savage.

I agree to follow all safety instructions and acknowledge that failure to do so may result in removal from the activity.

I release and hold harmless Velocity Labs, its operators, staff, volunteers, and event hosts from all liability, claims, or demands arising from participation, except in cases of gross negligence.

If I am signing on behalf of a minor, I certify that I am the parent or legal guardian and that I have the legal authority to sign this agreement.

By signing below, I acknowledge that I have read and agree to this waiver.
</textarea>

<label><b>Type your full name as signature</b></label>
<input type="text" id="signature" name="Signature" required>

<!-- hidden file input for PDF attachment -->
<input type="file" id="pdfAttachment" name="attachment" style="display:none">

<input type="hidden" name="_template" value="table">
<input type="hidden" name="_replyto" id="replyto">

<input type="hidden" name="_autoresponse"
value="Thank you for signing the Velocity Labs Drone Racing Waiver. Please keep this email for your records. Fly safe!">

<button type="submit">I Agree & Race</button>

</form>

<br>

<button onclick="downloadPDF()">Download My Waiver PDF</button>

<script>
function validateForm() {
  var age = document.getElementById("age").value;
  var guardian = document.getElementById("guardian").value;

  if (age < 18 && guardian.trim() === "") {
    alert("Parent or Guardian name is required for participants under 18.");
    return false;
  }
  return true;
}

async function buildPDFBlob() {
  const { jsPDF } = window.jspdf;
  var doc = new jsPDF();

  var name = document.querySelector('input[name="Participant Name"]').value || "";
  var age = document.getElementById("age").value || "";
  var guardian = document.getElementById("guardian").value || "";
  var email = document.getElementById("email").value || "";
  var phone = document.querySelector('input[name="Phone"]').value || "";
  var sig = document.getElementById("signature").value || "";
  var waiver = document.getElementById("waiverText").value;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("Velocity Labs Drone Racing Waiver", 105, 15, { align: "center" });

  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);

  let y = 30;
  const lineGap = 7;

  doc.text(`Participant: ${name}`, 15, y); y += lineGap;
  doc.text(`Age: ${age}`, 15, y); y += lineGap;

  if (guardian) {
    doc.text(`Guardian: ${guardian}`, 15, y);
    y += lineGap;
  }

  doc.text(`Email: ${email}`, 15, y); y += lineGap;
  doc.text(`Phone: ${phone}`, 15, y); y += lineGap;
  doc.text(`Signature: ${sig}`, 15, y); y += 10;

  const splitWaiver = doc.splitTextToSize(waiver, 180);
  doc.setFontSize(10);
  doc.text(splitWaiver, 15, y, { lineHeightFactor: 1.5 });

  return doc.output("blob");
}

async function handleSubmit(e) {
  if (!validateForm()) return false;

  document.getElementById("replyto").value =
    document.getElementById("email").value;

  // build PDF and attach
  const blob = await buildPDFBlob();
  const file = new File([blob], "Velocity_Labs_Waiver.pdf", { type: "application/pdf" });

  const container = new DataTransfer();
  container.items.add(file);
  document.getElementById("pdfAttachment").files = container.files;

  return true;
}

async function downloadPDF() {
  const blob = await buildPDFBlob();
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "Velocity_Labs_Waiver.pdf";
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
